/**
 * cor media 2013
 * @author: Mark Dooney (Desmarkie) 
 **/
var App,EditPanel,GameGrid,GamePlayer,GameRenderer,GameTextures,GameTile,Levels,__bind=function(a,b){return function(){return a.apply(b,arguments)}};EditPanel=function(){function a(){this.spriteClick=__bind(this.spriteClick,this),this.disable=__bind(this.disable,this),this.enable=__bind(this.enable,this);var a,b,c,d,e;for(this.view=new PIXI.DisplayObjectContainer,a=["normal","metal","corner"],b=d=0,e=a.length-1;e>=0?e>=d:d>=e;b=e>=0?++d:--d)c=new PIXI.Sprite(window.app.textures.getTexture(a[b])),c.position.x=64*b%576,c.position.y=64*Math.floor(b/64),this.sprites.push({sprite:c,id:a[b]}),this.view.addChild(c)}return a.prototype.view=null,a.prototype.sprites=[],a.prototype.enable=function(){var a,b,c,d;for(d=this.sprites,b=0,c=d.length;c>b;b++)a=d[b],a.sprite.interactive=!0,a.sprite.onclick=this.spriteClick;return null},a.prototype.disable=function(){var a,b,c,d;for(d=this.sprites,b=0,c=d.length;c>b;b++)a=d[b],a.sprite.interactive=!1,a.sprite.onclick=null;return null},a.prototype.spriteClick=function(a){var b,c,d,e;for(a.stopPropagation(),e=this.sprites,c=0,d=e.length;d>c;c++)b=e[c],b.sprite===a.target&&console.log("SELECTED : "+b.id);return null},a}(),GameRenderer=function(){function a(a){var b;this.view=a,this.tileClick=__bind(this.tileClick,this),this.setSprite=__bind(this.setSprite,this),this.setPickup=__bind(this.setPickup,this),this.clearPickup=__bind(this.clearPickup,this),this.drawTiles=__bind(this.drawTiles,this),this.hideEditPanel=__bind(this.hideEditPanel,this),this.showEditPanel=__bind(this.showEditPanel,this),this.hideLevel=__bind(this.hideLevel,this),this.showLevel=__bind(this.showLevel,this),this.render=__bind(this.render,this),this.texManager=window.app.textures,this.renderer=PIXI.autoDetectRenderer(640,640),this.stage=new PIXI.Stage(0,!0),this.bg=new PIXI.DisplayObjectContainer,b=new PIXI.Sprite(this.texManager.getTexture("bg")),b.scale.x=b.scale.y=2,this.bg.addChild(b),b=new PIXI.Sprite(this.texManager.getTexture("bg")),b.scale.x=b.scale.y=2,b.position.x=640,this.bg.addChild(b),b=new PIXI.Sprite(this.texManager.getTexture("bg")),b.scale.x=b.scale.y=2,b.position.y=640,this.bg.addChild(b),b=new PIXI.Sprite(this.texManager.getTexture("bg")),b.scale.x=b.scale.y=2,b.position.x=640,b.position.y=640,this.bg.addChild(b),this.stage.addChild(this.bg),this.levelHolder=new PIXI.DisplayObjectContainer,this.stage.addChild(this.levelHolder),this.levelHolder.position.x=320,this.levelHolder.position.y=320,this.tileHolder=new PIXI.DisplayObjectContainer,this.tileHolder.position.x=-320,this.tileHolder.position.y=-320,this.levelHolder.addChild(this.tileHolder),this.pickupHolder=new PIXI.DisplayObjectContainer,this.pickupHolder.position.x=-320,this.pickupHolder.position.y=-320,this.levelHolder.addChild(this.pickupHolder),this.playerSprite=new PIXI.Sprite(this.texManager.getTexture("player")),this.playerSprite.pivot.x=this.playerSprite.pivot.y=32,this.levelHolder.addChild(this.playerSprite),this.levelHolder.scale.x=this.levelHolder.scale.y=.25,this.levelHolder.alpha=0,this.levelHolder.rotation=Math.PI,this.editPanel=new EditPanel,this.view.appendChild(this.renderer.view)}return a.prototype.renderer=null,a.prototype.stage=null,a.prototype.tiles={},a.prototype.sprites=[],a.prototype.deadSprites=[],a.prototype.pickups={},a.prototype.deadPickups=[],a.prototype.tileSize=64,a.prototype.tileHolder=null,a.prototype.playerSprite=null,a.prototype.editPanel=null,a.prototype.editState="normal",a.prototype.render=function(a){return this.grid=a,this.drawTiles(this.grid.tiles,this.grid.gridWidth,this.grid.gridHeight),this.grid.player.x===this.grid.currentLevel.startPos.x&&this.grid.player.y===this.grid.currentLevel.startPos.y&&(this.playerSprite.scale.x=this.playerSprite.scale.y=this.playerSprite.alpha=1,this.playerSprite.rotation=0),this.playerSprite.position.x=this.grid.player.x*this.tileSize-320+32,this.playerSprite.position.y=this.grid.player.y*this.tileSize-320+32,this.grid.player.falling?(this.grid.player.falling=!1,TweenMax.to(this.playerSprite.scale,1,{x:.2,y:.2}),TweenMax.to(this.playerSprite,1,{rotation:Math.PI,alpha:0,onComplete:function(){return window.app.reset()}})):this.playerSprite.scale.x=this.playerSprite.scale.y=this.grid.player.scale,this.bg.position.x++,this.bg.position.y++,this.bg.position.x>0&&(this.bg.position.x-=640),this.bg.position.y>0&&(this.bg.position.y-=640),this.renderer.render(this.stage),null},a.prototype.showLevel=function(){return TweenMax.to(this.levelHolder,1,{alpha:1,rotation:0,ease:Power4.easeOut}),TweenMax.to(this.levelHolder.scale,1,{x:1,y:1,ease:Power4.easeOut}),null},a.prototype.hideLevel=function(a){var b=this;return TweenMax.to(this.levelHolder.scale,1,{x:2,y:2,ease:Power4.easeOut}),TweenMax.to(this.levelHolder,1,{alpha:0,rotation:-Math.PI,ease:Power4.easeOut,onComplete:function(){return b.levelHolder.scale.x=b.levelHolder.scale.y=.25,b.levelHolder.rotation=Math.PI,a()}}),null},a.prototype.showEditPanel=function(){return this.stage.addChild(this.editPanel.view),this.editPanel.enable(),null},a.prototype.hideEditPanel=function(){return this.stage.removeChild(this.editPanel.view),this.editPanel.disable(),null},a.prototype.drawTiles=function(a,b,c){var d,e,f,g,h,i,j;for(d=g=0,i=b-1;i>=g;d=g+=1)for(e=h=0,j=c-1;j>=h;e=h+=1)f=a[d][e],this.setSprite(f),f.pickup?this.setPickup(d,e):this.pickups[d+"_"+e]&&this.clearPickup(d,e);return null},a.prototype.clearPickup=function(a,b){return this.deadPickups.push(this.pickups[a+"_"+b]),this.pickupHolder.removeChild(this.pickups[a+"_"+b]),delete this.pickups[a+"_"+b],null},a.prototype.setPickup=function(a,b){var c,d,e,f,g,h,i;if(!this.pickups[a+"_"+b]){for(c=[],e=h=1;8>=h;e=h+=1)for(f=i=0;8>=i;f=i+=1)d=e,6===d?d=4:7===d?d=3:8===d&&(d=2),c.push(this.texManager.getTexture("pickup_0"+d));this.deadPickups.length>0?(g=this.deadPickups[0],this.deadPickups.splice(0,1)):g=new PIXI.MovieClip(c),g.position.x=a*this.tileSize,g.position.y=b*this.tileSize,this.pickups[a+"_"+b]=g,this.pickupHolder.addChild(g),g.gotoAndPlay(Math.ceil(Math.random()*c.length))}return null},a.prototype.setSprite=function(a){var b;return b=a.x+"_"+a.y,this.tiles[b]?this.texManager.getTexture(a.state)!==this.tiles[b].texture&&this.tiles[b].setTexture(this.texManager.getTexture(a.state)):(this.tiles[b]=new PIXI.Sprite(this.texManager.getTexture(a.state)),this.tiles[b].position.x=a.x*this.tileSize,this.tiles[b].position.y=a.y*this.tileSize,this.tileHolder.addChild(this.tiles[b]),this.tiles[b].interactive=!0,this.tiles[b].mousedown=this.tileClick),this.tiles[b]},a.prototype.tileClick=function(a){var b,c,d;if(window.app.editMode)return c=Math.floor(a.target.position.x/64),d=Math.floor(a.target.position.y/64),"pickup"!==this.editState?(b=this.grid.tiles[c][d].state,this.grid.tiles[c][d].state=this.editState):this.grid.tiles[c][d].pickup=!this.grid.tiles[c][d].pickup,null},a}(),GameGrid=function(){function a(a){this.completeCallback=a,this.getLevelData=__bind(this.getLevelData,this),this.update=__bind(this.update,this),this.openExits=__bind(this.openExits,this),this.checkExit=__bind(this.checkExit,this),this.checkPickup=__bind(this.checkPickup,this),this.checkJump=__bind(this.checkJump,this),this.checkFloor=__bind(this.checkFloor,this),this.checkLanding=__bind(this.checkLanding,this),this.createGrid=__bind(this.createGrid,this),this.clearCurrentLevel=__bind(this.clearCurrentLevel,this),this.player=new GamePlayer(this,0,0)}return a.prototype.gridWidth=10,a.prototype.gridHeight=10,a.prototype.player=null,a.prototype.tiles=null,a.prototype.pickups=null,a.prototype.exits=!1,a.prototype.complete=!1,a.prototype.currentLevel=null,a.prototype.exitPos={x:0,y:0},a.prototype.clearCurrentLevel=function(){return this.tiles=null,this.pickups=null,this.exits=!1,this.complete=!1,null},a.prototype.createGrid=function(a){var b,c,d,e,f,g;for(null!==this.currentLevel&&this.clearCurrentLevel(),this.currentLevel=a,this.tiles=[],this.pickups=[],b=d=0,f=this.gridWidth-1;f>=d;b=d+=1)for(this.tiles[b]=[],c=e=0,g=this.gridHeight-1;g>=e;c=e+=1)this.tiles[b][c]=new GameTile(b,c),this.currentLevel[b+"_"+c]&&(this.tiles[b][c].state=this.currentLevel[b+"_"+c],("exit_open"===this.tiles[b][c].state||"exit_closed"===this.tiles[b][c].state)&&(this.tiles[b][c].state="exit_closed",this.exitPos.x=b,this.exitPos.y=c),this.currentLevel.pickups[b+"_"+c]&&(this.tiles[b][c].pickup=!0,this.pickups.push(b+"_"+c)));return this.numPickups=this.pickups.length,this.player.toStartPosition(this.currentLevel.startPos.x,this.currentLevel.startPos.y),null},a.prototype.checkLanding=function(a,b){return window.app.editMode?void 0:(this.checkFloor(a,b),this.checkPickup(a,b),this.checkJump(a,b),this.exits&&this.checkExit(a,b),null)},a.prototype.checkFloor=function(a,b){return"normal"===this.tiles[a][b].state&&this.player.fall(),null},a.prototype.checkJump=function(a,b){return"jump"===this.tiles[a][b].state&&this.player.jump(),null},a.prototype.checkPickup=function(a,b){var c;if(!this.complete)return c=this.pickups.indexOf(a+"_"+b),-1!==c&&(this.tiles[a][b].pickup=!1,this.numPickups--,this.pickups.splice(c,1)),0===this.numPickups&&this.openExits(),null},a.prototype.checkExit=function(a,b){return this.complete?void 0:(a===this.exitPos.x&&b===this.exitPos.y&&(this.complete=!0,this.completeCallback()),null)},a.prototype.openExits=function(){return this.exits=!0,this.tiles[this.exitPos.x][this.exitPos.y].state="exit_open",null},a.prototype.update=function(){var a,b,c;if(!this.complete)return this.player.isMoving||(a={x:0,y:0},window.app.leftPressed&&(a.x-=1,window.app.leftPressed=!1),window.app.rightPressed&&(a.x+=1,window.app.rightPressed=!1),window.app.upPressed&&(a.y-=1,window.app.upPressed=!1),window.app.downPressed&&(a.y+=1,window.app.downPressed=!1),(0!==a.x||0!==a.y)&&(b=this.player.x+a.x,c=this.player.y+a.y,this.currentLevel[b+"_"+c]||window.app.editMode?this.player.move(a.x,a.y):a.x=a.y=0)),null},a.prototype.getLevelData=function(){var a,b,c,d,e,f,g,h,i;for(c={},d={},e={x:this.player.x,y:this.player.y},a=f=0,h=this.gridWidth-1;h>=f;a=f+=1)for(b=g=0,i=this.gridHeight-1;i>=g;b=g+=1)"normal"!==this.tiles[a][b].state&&(c[a+"_"+b]=this.tiles[a][b].state),this.tiles[a][b].pickup&&(d[a+"_"+b]=!0);return c.pickups=d,c.startPos=e,c},a}(),GamePlayer=function(){function a(a,b,c){this.grid=a,this.x=b,this.y=c,this.jump=__bind(this.jump,this),this.fall=__bind(this.fall,this),this.toStartPosition=__bind(this.toStartPosition,this),this.doMove=__bind(this.doMove,this),this.move=__bind(this.move,this),this.isMoving=!1}return a.prototype.lastMove=null,a.prototype.falling=!1,a.prototype.scale=1,a.prototype.move=function(a,b){var c,d;return this.lastMove={x:a,y:b},this.isMoving=!0,c=this.x+a,d=this.y+b,0>c?c=0:c>this.grid.gridWidth-1&&(c=this.grid.gridWidth-1),0>d?d=0:d>this.grid.gridHeight-1&&(d=this.grid.gridHeight-1),c!==this.x||d!==this.y?(this.isMoving=!0,this.doMove(c,d,!1)):this.isMoving=!1,null},a.prototype.doMove=function(a,b,c){var d,e=this;return d=c?1:.15,c&&TweenMax.to(this,.5*d,{scale:1.5,ease:Power2.easeOut,onComplete:function(){return TweenMax.to(e,.5*d,{scale:1,ease:Power2.easeIn})}}),TweenMax.to(this,d,{x:a,y:b,ease:Power2.easeOut,onComplete:function(){return e.grid.checkLanding(a,b),e.isMoving=!1}}),null},a.prototype.toStartPosition=function(a,b){return this.x=a,this.y=b,null},a.prototype.fall=function(){return this.falling=!0,null},a.prototype.jump=function(){var a,b;return this.isMoving=!0,a=this.x+2*this.lastMove.x,b=this.y+2*this.lastMove.y,this.doMove(a,b,!0),null},a}(),GameTextures=function(){function a(a){var b,c,d,e,f;for(this.images=a,this.getTexture=__bind(this.getTexture,this),this.prepareTextures=__bind(this.prepareTextures,this),this.load=__bind(this.load,this),b=[],f=this.images,d=0,e=f.length;e>d;d++)c=f[d],b.push(c.url);this.loader=new PIXI.AssetLoader(b)}return a.prototype.textures={},a.prototype.load=function(a){return this.onComplete=a,this.loader.onComplete=this.prepareTextures,this.loader.load(),null},a.prototype.prepareTextures=function(){var a,b,c,d;for(d=this.images,b=0,c=d.length;c>b;b++)a=d[b],this.textures[a.id]=PIXI.Texture.fromImage(a.url);return this.onComplete(),null},a.prototype.getTexture=function(a){return this.textures[a]},a}(),GameTile=function(){function a(a,b){this.x=a,this.y=b,this.state="normal"}return a.prototype.pickup=!1,a}(),Levels=function(){function a(){}return a.EmptyLevel={pickups:{},startPos:{x:0,y:0}},a.LevelOne={pickups:{"3_2":"true","3_7":"true","6_5":"true"},startPos:{x:5,y:0},"0_9":"exit_open","1_9":"metal","2_9":"metal","3_0":"metal","3_1":"metal","3_2":"metal","3_3":"metal","3_6":"metal","3_7":"metal","3_8":"metal","3_9":"metal","4_0":"metal","4_3":"metal","4_6":"metal","5_0":"corner","5_3":"metal","5_6":"metal","6_3":"metal","6_4":"metal","6_5":"metal","6_6":"metal"},a.LevelTwo={pickups:{"5_3":"true","5_7":"true"},startPos:{x:2,y:3},"2_3":"corner","2_7":"exit_open","3_3":"metal","3_7":"metal","4_3":"metal","4_4":"metal","4_7":"metal","5_3":"metal","5_4":"jump","5_7":"metal","6_3":"metal","6_7":"metal","7_3":"metal","7_4":"jump","7_6":"metal","7_7":"metal"},a.LevelThree={pickups:{"4_4":"true","7_4":"true","7_7":"true"},startPos:{x:1,y:3},"1_3":"corner","1_7":"exit_closed","2_3":"metal","2_7":"metal","3_3":"jump","3_7":"metal","4_4":"metal","4_5":"metal","4_6":"metal","4_7":"metal","5_3":"jump","6_2":"metal","6_3":"metal","6_4":"jump","6_6":"metal","6_7":"metal","7_3":"metal","7_4":"metal","7_6":"jump","7_7":"metal"},a.LevelFour={pickups:{"1_3":"true","4_2":"true","7_7":"true"},startPos:{x:4,y:8},"1_3":"metal","1_4":"metal","1_5":"metal","2_3":"metal","2_5":"jump","3_3":"metal","3_4":"metal","3_6":"jump","3_7":"metal","4_1":"exit_open","4_2":"metal","4_4":"jump","4_5":"jump","4_6":"jump","4_7":"metal","4_8":"corner","5_4":"metal","5_6":"jump","5_7":"metal","6_5":"metal","7_5":"metal","7_6":"metal","7_7":"jump","8_6":"metal","8_7":"metal"},a.Levels=[a.LevelOne,a.LevelTwo,a.LevelThree,a.LevelFour],a}(),App=function(){function a(){this.parseLevelData=__bind(this.parseLevelData,this),this.reset=__bind(this.reset,this),this.parseCurrentLevel=__bind(this.parseCurrentLevel,this),this.toggleEditMode=__bind(this.toggleEditMode,this),this.handleKeyRelease=__bind(this.handleKeyRelease,this),this.handleKeyPress=__bind(this.handleKeyPress,this),this.handleTouch=__bind(this.handleTouch,this),this.update=__bind(this.update,this),this.levelComplete=__bind(this.levelComplete,this),this.resize=__bind(this.resize,this),this.init=__bind(this.init,this);var a;a=[{url:"img/pickup_01.png",id:"pickup_01"},{url:"img/pickup_02.png",id:"pickup_02"},{url:"img/pickup_03.png",id:"pickup_03"},{url:"img/pickup_04.png",id:"pickup_04"},{url:"img/pickup_05.png",id:"pickup_05"},{url:"img/tile-exit-closed.jpg",id:"exit_closed"},{url:"img/tile-exit-open.jpg",id:"exit_open"},{url:"img/bg.jpg",id:"bg"},{url:"img/metal-tile.jpg",id:"metal"},{url:"img/corner-tile.jpg",id:"corner"},{url:"img/plain-tile.png",id:"normal"},{url:"img/jump-tile.jpg",id:"jump"},{url:"img/player.png",id:"player"}],this.textures=new GameTextures(a),this.textures.load(this.init),$("#parse-button").bind("click",this.parseCurrentLevel)}return a.prototype.renderer=null,a.prototype.textures=null,a.prototype.upPressed=!1,a.prototype.downPressed=!1,a.prototype.leftPressed=!1,a.prototype.rightPressed=!1,a.prototype.topMargin=0,a.prototype.leftMargin=0,a.prototype.editMode=!1,a.prototype.editStates=["normal","metal","corner","exit_open","jump"],a.prototype.levels=null,a.prototype.currentLevel=3,a.prototype.gameScale=1,a.prototype.init=function(){return this.levels=Levels.Levels,this.grid=new GameGrid(this.levelComplete),this.grid.createGrid(this.levels[this.currentLevel]),this.renderer=new GameRenderer(document.getElementById("game-holder")),window.onresize=this.resize,this.resize(),this.renderer.showLevel(),Modernizr.touch?this.renderer.renderer.view.addEventListener("touchstart",this.handleTouch,!1):(window.onkeydown=this.handleKeyPress,window.onkeyup=this.handleKeyRelease),requestAnimationFrame(this.update),null},a.prototype.resize=function(){var a;return window.innerWidth<640||window.innerHeight<640?(a=window.innerWidth/640,window.innerHeight/640<a&&(a=window.innerHeight/640),this.gameScale=a):this.gameScale=1,$("canvas").css("width",640*this.gameScale+"px"),$("canvas").css("height",640*this.gameScale+"px"),$("#game-holder").css("width",640*this.gameScale+"px"),$("#game-holder").css("height",640*this.gameScale+"px"),this.leftMargin=.5*(window.innerWidth-640*this.gameScale),this.topMargin=.5*(window.innerHeight-640*this.gameScale),$("#game-holder").css("left",this.leftMargin+"px"),$("#game-holder").css("top",this.topMargin+"px"),$("#game-holder").css("margin-left","0px"),$("#game-holder").css("margin-top","0px"),null},a.prototype.levelComplete=function(){var a=this;return this.renderer.hideLevel(function(){return a.currentLevel++,a.currentLevel===a.levels.length&&(a.currentLevel=0),a.grid.createGrid(a.levels[a.currentLevel]),a.renderer.showLevel()}),null},a.prototype.update=function(){return this.grid.update(),this.renderer.render(this.grid),requestAnimationFrame(this.update),null},a.prototype.preloadImages=function(){var a;return a=["img/plain-tile.jpg"],this.loader=new PIXI.AssetLoader(a),this.loader.onComplete=this.init,this.loader.load(),null},a.prototype.handleTouch=function(a){var b,c,d,e;return a.preventDefault(),b=320*this.gameScale-(a.touches[0].pageX-this.leftMargin),c=!1,e=!1,0>b&&(b*=-1,c=!0),d=320*this.gameScale-(a.touches[0].pageY-this.topMargin),0>d&&(d*=-1,e=!0),d>b?e?this.downPressed=!0:this.upPressed=!0:c?this.rightPressed=!0:this.leftPressed=!0,null},a.prototype.handleKeyPress=function(a){var b;return b=a.keyCode?a.keyCode:a.charCode,(37===b||65===b)&&(this.leftPressed=!0),(39===b||68===b)&&(this.rightPressed=!0),(38===b||87===b)&&(this.upPressed=!0),(40===b||83===b)&&(this.downPressed=!0),this.debug.innerHTML="_",null},a.prototype.handleKeyRelease=function(a){var b;return b=a.keyCode?a.keyCode:a.charCode,(37===b||65===b)&&(this.leftPressed=!1),(39===b||68===b)&&(this.rightPressed=!1),(38===b||87===b)&&(this.upPressed=!1),(40===b||83===b)&&(this.downPressed=!1),69===b&&this.toggleEditMode(),b>=48&&57>=b&&(this.renderer.editState=this.editStates[b-48]),80===b&&(this.renderer.editState="pickup"),82===b&&this.reset(),null},a.prototype.toggleEditMode=function(){return this.editMode=!this.editMode,null},a.prototype.parseCurrentLevel=function(){var a,b;return console.log("PARSING"),a=this.grid.getLevelData(),console.log(a),b=this.parseLevelData(a),null},a.prototype.reset=function(){var a=this;return this.renderer.hideLevel(function(){return a.grid.createGrid(a.levels[a.currentLevel]),a.renderer.showLevel()}),null},a.prototype.parseLevelData=function(a){var b,c,d;console.log("READING DATA :: "+a),c="",c+="pickups:{\n";for(b in a.pickups)c+='"'+b+'" : "'+a.pickups[b]+'",\n';c+="},\n",c+="startPos:{\n",c+="x:"+a.startPos.x+",\ny:"+a.startPos.y+"\n",c+="},\n";for(d in a)"pickups"!==d&&"startPos"!==d&&(c+='"'+d+'" : "'+a[d]+'",\n');return console.log("LEVEL STRING = \n"+c),c},a}();